{% extends "ChateaClientBundle::mainLayout.html.twig" %}

{% block head_css %}
    {{ parent() }}

    {% stylesheets
    'bundles/apisocial/raty/jquery.raty.css'
    filter='cssrewrite'
    %}
    <link href="{{ asset_url }}" type="text/css" rel="stylesheet" />
    {% endstylesheets %}
{% endblock head_css %}

{% block chatea_body %}
    <div class="row">
        <div class="col-md-8 col-md-offset-2">

            <div id="vote_container">

                <h1>Votar foto <span id="username"></span> <a href="#" class="btn btn-primary pull-right" id="go_to_next">Siguiente</a></h1>
                <div id="raty"></div>
                <br>
                <div class="row col-xs-12" >
                    <img src="" id="profile_photo" />
                </div>
                <p>&nbsp;&nbsp;</p>

            </div>
        </div>
    </div>
    <br>
    <div class="row col-md-5 col-md-offset-2">
        <a href="#" class="btn btn-danger" id="go_report">Denunciar</a>

    </div>
    <br style="clear:both">
{% endblock %}

{% block body_js_end %}
    {{ parent() }}
    {% javascripts
    '@ApiSocialBundle/Resources/public/raty/jquery.raty.js'

    %}
    <script src="{{ asset(asset_url) }}"></script>
    {% endjavascripts %}
    <script>
        var token ="MTA3ZTMyZTE0ZjBkNzgzMDZmZmE5YTZmM2Q1OTMyN2FlNzBkMDNkMGExNTIwOWMxMGIyYWNmMmZmNmE5ODhlNXJ1MDE0NDExMDkyNTdlNzQzMGRlOGE3MjU3ZDZjNzM3OWMyNWEwNjY2OWZkMDM0ZWQwNjZkZjM3OGVmYWNjOWI5MjRlYzE2MWU3NjM5";
        window.api_endpoint = "http://api.chatsfree.lo/app_dev.php";
        var users = [];
        var current_user;
        function getUsers() {
            $.ajax({
                        url: window.api_endpoint + "/api/users?filters=language%3Des%2Chas_profile_photo%3D1&limit=30&offset=0&order=randomly%3Dasc",
                        beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + token); },
                        success: function(data, status) {
                            users = data.resources;
                            showUser();
                        }
                    }
            );
        }

        $("#go_to_next").click(function () {
            nextUser();
        });

        function nextUser() {
            if(users.length == 0) getUsers();
            else {
                showUser();
            }
        }

        function showUser() {
            current_user = users.shift();
            $("#username").html(current_user.username);
            $("#profile_photo").attr("src",current_user.profile.profile_photo.path_large);
        }

        function sendScore(score, user) {
            $.ajax(
                    {
                        type: "POST",
                        accept: "application/json",
                        url: window.api_endpoint + "/api/users/{{ app.user.id }}/vote",
                        data: {"_format":"json", "vote[photo]": user.profile.profile_photo.id, "vote[score]": score },
                        beforeSend: function(xhr, settings) {
                            xhr.setRequestHeader('Authorization','Bearer ' + token);
                        }
                    }
            );

        }

        $('#raty').raty({
            number: 10, path: '/bundles/apisocial/raty/images/',
            click: function(score, evt) {
                nextUser();
                sendScore(score, current_user);
                return false;
            }
        });



        nextUser();
    </script>

{% endblock %}
