define(["app","apps/messages/index/index_view","entities/messages","entities/threads"],function(e,t,n){return e.module("MessagesApp.Index",function(e,r,i,s,o,u){e.Controller={Index:function(){this.activeBox="index";var e=r.request("thread:entities"),t=u.bind(this._showThreadsList,this);this._initLayout(),this.layout.setActiveTab("inbox-tab"),o.when(e).done(t).fail(function(e){requirejs(["apps/commons/errors/generic"],function(t){r.container_center_Region.show(new t.GenericErrorView({model:e}))})})},Sent:function(){this.activeBox="sent";var e=r.request("thread:entities:sent"),t=u.bind(this._showThreadsList,this);this._initLayout(),this.layout.setActiveTab("sent-tab"),o.when(e).done(t)},_showThreadsList:function(e){var n=new t.Threads({collection:e});n.on("itemview:thread:show",function(e){r.trigger("messages:showThread",e.model.get("id"))}),this._showInLayout(n)},ShowThread:function(e){var n=r.request("thread:messages",e),i=this;o.when(n).done(function(e){var n=new t.Messages({collection:e}),r=u.bind(i._showReplayThread,i),s=u.bind(i._deleteThread,i),o=u.bind(i._triggerMessageActiveBox,i);n.on("thread:reply",r),n.on("thread:delete",s),n.on("thread:back",o),i._showInLayout(n)})},_showReplayThread:function(e){var t=this;requirejs(["apps/messages/composer/compose_view","text!apps/messages/composer/templates/reply.html","text!apps/messages/composer/templates/reply_form.html"],function(r,i,s){var o=new n.Message({thread:e}),a=new r.ComposeView({model:o,formTemplate:s}),f=u.bind(t._replayThread,t,e);a.on("compose:submit",f),a.on("compose:back",function(){a.remove()}),t.layout.mainRegion.currentView.showReply(a)})},_deleteThread:function(e){var t=this;r.request("thread:delete",e).done(u.bind(t._triggerMessageActiveBox,t))},_replayThread:function(e,t){t.unset("thread"),t.save(null,{success:function(){r.trigger("messages:showThread",e.id)}})},Compose:function(t){var n=this;requirejs(["entities/threads","apps/messages/composer/compose_view"],function(r,i){var s=new r.NewThread({recipient:t?t:""}),o=new i.ComposeView({model:s});o.on("compose:submit",u.bind(n._sendMessage,n)),o.on("compose:back",u.bind(n._triggerMessageActiveBox,n)),e.Controller._showInLayout(o)})},_sendMessage:function(e){var t=this;e.save(null,{success:function(){var n=e.get("participants"),i;for(var s in n)n[s].username==e.get("recipient")&&(i=n[s].id);r.sendEventAnalytics("event","Users","Message",i),t._triggerMessageActiveBox()}})},_triggerMessageActiveBox:function(){r.trigger("messages:"+(this.activeBox||"index"))},_showInLayout:function(e){var t=this;this._initLayout(),this.layoutInitialized?this.layout.mainRegion.show(e):(t.layout.on("show",function(){t.layout.mainRegion.show(e),t.layoutInitialized=!0}),r.body_container_main_Region.show(this.layout))},_initLayout:function(){if(this.layout==null||typeof this.layout=="undefined"||typeof this.layout.mainRegion=="undefined"){this.layoutInitialized=!1;var e=new t.Layout;e.on("thread:compose",function(){r.trigger("messages:compose")}),e.on("inbox",function(){r.trigger("messages:index")}),e.on("sent",function(){r.trigger("messages:sent")}),this.layout=e}}}}),e.MessagesApp.onStop=function(){e.MessagesApp.Index.Controller.layout=null},e.MessagesApp.Index.Controller});