define(["app","apps/users/list/list_controller","apps/users/show/show_controller","apps/chat/show/show_controller","entities/profile","entities/photo","apps/users/test/fixtures","util/testutils","jasmine-fixture","apps/users/users_app","apps/dashboard/dashboard_app","apps/chat/chat_app"],function(e,t,n,r,i,s,o){return window.user_id="1",describe("UsersApp.Controller",function(){var r=function(e){var t=$.Deferred(),n=t.promise();return t.resolve(e),n},u=this;u.hasNoPhoto=!1,u.ownesNoChannel=!1,u.moderatesNoChannel=!1,u.isFanNoChannel=!1,u.profileApiUrlCalled=!0,beforeEach(function(){sinon.stub(jQuery,"ajax",function(e){if(e.url=="http://myserver/api/users"){var t={resources:o.collection.toJSON(),total:40,limit:40,offset:0,count:40,totalPages:2};e.data.offset&&(t.resources=t.resources.slice(e.data.offset,e.data.offset+e.data.limit)),e.success(t)}else if(e.url=="http://myserver/app_dev.php/api/users/1/channels"){if(u.ownesNoChannel)var t={resources:[],total:0,limit:10,offset:0,count:0,totalPages:1};else var t={resources:o.channels.toJSON(),total:10,limit:10,offset:0,count:10,totalPages:1};e.success(t)}else if(e.url=="http://myserver/app_dev.php/api/users/1/moderated"){if(u.moderatesNoChannel)var t={resources:[],total:0,limit:10,offset:0,count:0,totalPages:1};else var t={resources:o.moderated.toJSON(),total:10,limit:10,offset:0,count:10,totalPages:1};e.success(t)}else if(e.url=="http://myserver/app_dev.php/api/users/1/channelsFan"){if(u.isFanNoChannel)var t={resources:[],total:0,limit:10,offset:0,count:0,totalPages:1};else var t={resources:o.fans.toJSON(),total:10,limit:10,offset:0,count:10,totalPages:1};e.success(t)}else if(e.url=="http://myserver/app_dev.php/api/channels?limit=6&filter=isRoot=1"){var t={resources:o.fans.toJSON(),total:10,limit:10,offset:0,count:10,totalPages:1};e.success(t)}else if(e.url=="http://myserver/api/users/1/profiles"){u.profileApiUrlCalled=!0;var t={};e.success(t)}else{var t={resources:{},total:0,limit:10,offset:0,count:0,totalPages:1};e.success(t)}}),e.navigate("social-dinamic/app/SpecRunner.html")}),afterEach(function(){jQuery.ajax.restore(),u.hasNoPhoto=!1,u.ownesNoChannel=!1,u.moderatesNoChannel=!1,u.isFanNoChannel=!1,u.profileApiUrlCalled=!1,e.navigate("social-dinamic/app/SpecRunner.html")}),describe("Index",function(){beforeEach(function(){u.showUserStub=sinon.stub(n,"showUser")}),afterEach(function(){u.showUserStub.restore()}),it("should show list of users",function(){t.listUsers(),waitsForSpyToBeCalled(jQuery.ajax),runs(function(){expect(jQuery.ajax).toHaveBeenCalled(),expect($(".ace-thumbnails > li").length).toEqual(30),waitsFor(function(){return $(".pagination").length>0}),runs(function(){expect($(".page").last().html()).toEqual("2")})})}),it("should be pageable",function(){t.listUsers();var n=sinon.stub(e,"navigate");waitsForSpyToBeCalled(jQuery.ajax),runs(function(){$(".page").last().trigger("click"),waitsFor(function(){return $(".ace-thumbnails > li").length==10}),runs(function(){expect($(".ace-thumbnails > li").length).toEqual(10),expect(e.navigate).toHaveBeenCalledWith("users/2"),n.restore()})})}),it("should be able to access a users info page",function(){t.listUsers(),waitsForSpyToBeCalled(jQuery.ajax),runs(function(){$(".ace-thumbnails > li a.user-detail-link").first().trigger("click"),waitsForSpyToBeCalled(u.showUserStub),runs(function(){expect(u.showUserStub).toHaveBeenCalledWith("user_1",1)})})})}),describe("User details",function(){beforeEach(function(){var t=r(o.photos),a=e.request;this.appRequestStub=sinon.stub(e,"request",function(){if(arguments[0]=="user:entity"){var n=o.user1;return n.set("channels",o.channels),n.set("channels_moderated",o.channels),n.set("channels_fan",o.channels),r(n)}if(arguments[0]=="user:entity:me"){var f=o.user1.clone();return f.set("profile",new i.Profile(f.get("profile"))),f.get("profile").get("profile_photo")&&f.get("profile").set("profile_photo",new s.Photo(f.get("profile").get("profile_photo"))),r(f)}if(arguments[0]=="photo:entities")return u.hasNoPhoto?r(new Backbone.Collection([])):t;arguments[0]=="profile:entity"&&a.apply(e,arguments)}),n.showUser("user_1",1)}),afterEach(function(){this.appRequestStub.restore()});var t=function(e){return $(".profile-info-name:contains("+e+")").parent().find(".profile-info-value span").html()};it("should call the user profile api url",function(){waitsFor(function(){return u.profileApiUrlCalled===!0}),runs(function(){expect(u.profileApiUrlCalled).toEqual(!0)})}),it("should show the details of a user",function(){waitsForPresenceOfDOMElement(".profile-user-info"),runs(function(){expect(t("Username")).toEqual("user_1"),expect(t("Gender")).toEqual("female"),expect(t("Seeking")).toEqual("men")})}),describe("User photos",function(){it("should list the photos of a user",function(){$("#photos").trigger("click"),waitsForPresenceOfDOMElement("h2:contains('Photos')"),runs(function(){expect($("#users_show img.lazy").length).toEqual(10)})}),it("should show the message 'This user has no photo' when the user has no photo",function(){u.hasNoPhoto=!0,$("#photos").trigger("click"),waitsForPresenceOfDOMElement("h2:contains('Photos')"),runs(function(){expect($("#users_show img.lazy").length).toEqual(0),expect($("p:contains('This user has no photos')").length).toEqual(1)})})}),describe("Channels of user",function(){it("should be posible to view the channels a user ownes",function(){ensureNumberOfElementsArePresent("#channels_owner .col-lg-4",9),ensureNumberOfElementsArePresent('.channelList a[href="users/1/channels/owner"]',1)}),it("should be posible to view the channels a user is moderator",function(){ensureNumberOfElementsArePresent("#channels_moderator .col-lg-4",9),ensureNumberOfElementsArePresent('.channelList a[href="users/1/channels/moderator"]',1)}),it("should be posible to view the channels a user is fan",function(){$("#channelsFan").trigger("click"),ensureNumberOfElementsArePresent("#channels_fan .col-lg-4",9),ensureNumberOfElementsArePresent('.channelList a[href="users/1/channels/fan"]',1)})}),describe("Write message",function(){it("should be able to access the write message to user form",function(){$("#message").trigger("click"),waitsForPresenceOfDOMElement("span:contains('Send')"),runs(function(){expect($("input[name=subject]").length).toEqual(1),expect($("textarea[name=body]").length).toEqual(1)})}),it("shoud not show the write message tab if we are viewing the current users page",function(){var e=window.user_id;window.user_id=1,n.showUser("user_1",1),waitsForPresenceOfDOMElement(".profile-user-info"),runs(function(){expect($("#message").length).toEqual(0),window.user_id=e})})})})}),{name:"users_controller_spec"}});