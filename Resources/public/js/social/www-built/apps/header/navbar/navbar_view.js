define(["app","handlebars","text!apps/header/navbar/templates/widget_message_item.html","text!apps/header/navbar/templates/widget_no_messages.html"],function(e,t,n,r){return e.module("HeaderApp.Navbar.View",function(e,i,s,o,u,a){var f=o.ItemView.extend({tagName:"li",template:t.compile(n),events:{click:"messageClicked"},initialize:function(){var e=this;i.on("messages:showThread",function(t){e.model.get("id")==t&&(e.remove(),e.unbind())})},messageClicked:function(e){e.preventDefault(),e.stopPropagation(),this.trigger("message:clicked",this.model)}}),l=o.ItemView.extend({tagName:"li",template:r,render:function(){return this.$el.html(this.template),this}});e.Navbar=o.ItemView.extend({el:u("#navbar"),mailWidgetOpened:!1,initialize:function(){var e=this;e.unreadedThreads=[],e.unreadedThreadsViews=[],i.on("messages:showThread",function(t){e.unreadedThreads.length>0&&(e.unreadedThreads=e.unreadedThreads.filter(function(e){return e.get("id")!=t}),e.renderUnreadedMesseges(),e.updateNumberOfUnreadedThreads())})},events:{"click #unreaded-messages-icon":"iconClicked","click #all-messages-link":"seeAllMessagesClicked","click #go_to_dashboard":"goToDashboard"},updateUnreadedThreads:function(e){this.unreadedThreads=e,this.renderUnreadedMesseges(),this.updateNumberOfUnreadedThreads()},updateNumberOfUnreadedThreads:function(){this.$el.find(".n-unreaded-messages").html(this.unreadedThreads.length||0)},renderUnreadedMesseges:function(){var e=this.$el.find("#all-messages-link"),t=this;this.removeUnreadedMessages();if(!this.unreadedThreads||this.unreadedThreads.length===0){var n=new l;this.unreadedThreadsViews.push(n),u(n.render().$el).insertBefore(e)}else a.each(a.first(this.unreadedThreads,5),function(n){var r=new f({model:n});r.on("message:clicked",function(e){t.$el.find("#unreaded-messages-icon").removeClass("open"),t.trigger("message:clicked",e)}),t.unreadedThreadsViews.push(r),u(r.render().$el).insertBefore(e)})},removeUnreadedMessages:function(){a.each(this.unreadedThreadsViews,function(e){e.remove(),e.unbind()}),this.unreadedThreadsViews=[]},iconClicked:function(e){e.preventDefault(),e.stopPropagation();var t=u(e.currentTarget);return this.mailWidgetOpened?t.removeClass("open"):(i.sendEventAnalytics("event","Navbar","Messages"),t.addClass("open")),this.mailWidgetOpened=!this.mailWidgetOpened,!1},seeAllMessagesClicked:function(){i.trigger("messages:index")},goToDashboard:function(){i.trigger("dashboard:show")}})}),e.HeaderApp.Navbar.View});