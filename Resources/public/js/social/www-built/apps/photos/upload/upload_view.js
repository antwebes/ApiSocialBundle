define(["app","text!apps/photos/upload/templates/upload_photo.html","apps/channels/form/formView","entities/photo","entities/user","jquery.fileapi"],function(e,t,n,r){return e.module("PhotosApp.Upload.View",function(e,n,i,s,o,u){e.FormItem=s.ItemView.extend({template:Handlebars.compile(t),default_options:{message:"Upload photo",profile:!0,checked:!1,profile_hidden:!1},events:{"click #want_profile_photo":"checkInput","click #sendImage":"uploadImage","click .up-file":"uploadMetodFile","click .up-webcam":"uploadMetodWebcam"},uploadMetodFile:function(){o(".up-webcam").removeClass("active"),o(".up-file").addClass("active"),o("#userpic").show(),o("#webcam").hide()},uploadMetodWebcam:function(){o(".up-file").removeClass("active"),o(".up-webcam").addClass("active"),o("#webcam").show(),o("#userpic").hide()},showError:function(e){o("#errors").show(),(e.minWidth||e.minHeight)&&o("#errors").html("You should upload an image to a larger size. ( min size 200x200 )")},checkInput:function(){this.default_options.checked=!0},initialize:function(e){e.configure&&e.configure.done?this.default_options.after_upload_callback=e.configure.done:this.default_options.after_upload_callback=this.afterUpload},render:function(){var e=this,r=n.request("user:entity:me",window.user_id);o.when(r).done(function(n){(!n.get("profile")||!n.get("profile").get("profile_photo"))&&e.default_options.profile&&(e.default_options.checked=!0);var r=u.extend(e.default_options,e.options.configure),i=Handlebars.compile(t);e.$el.append(i({options:r})),e.showUpload(r),e.showUploadWebcam(r),e.$el.find("#want_profile_photo").prop("checked",e.default_options.checked)})},onShow:function(){var e=u.extend(this.default_options,this.options.configure);this.showUpload(e),this.showUploadWebcam(e)},onPostUpload:function(e,t){if(e.checked){var r=function(){e.after_upload_callback(!0,t)};n.request("user:profile_photo:assigne",window.user_id,t.id,r,r)}else e.after_upload_callback(!1,t)},afterUpload:function(e,t){if(e){var i=n.User;i.get("profile").set("profile_photo",new r.Photo(t)),n.trigger("users:navbar:me")}n.trigger("photos:me")},showUploadWebcam:function(e){var t=this;o("#webcam").fileapi({url:window.api_endpoint+"/api/users/"+window.user_id+"/photo?access_token="+window.token,accept:"image/*",paramName:"image",autoUpload:!0,imageOriginal:!1,duplicate:!1,elements:{active:{show:".js-upload",hide:".js-webcam"},preview:{el:".js-preview",width:200,height:200},progress:".js-progress"}}),o(".js-webcam","#webcam").click(function(r){var i=o("#popup").modal({closeOnOverlayClick:!1,onOpen:function(r){o(".js-img",r).webcam({width:200,height:200,paramName:"image",error:function(e){o.modal().close()},success:function(s){o(r).on("click",".js-upload",function(){var r=s.shot(),o=r.preview(200,200);if(o.errors){t.showError(o.errors);return}FileAPI.upload({url:window.api_endpoint+"/api/users/"+window.user_id+"/photo?access_token="+window.token,files:{image:o},complete:function(r,i){var s=JSON.parse(i.responseText);t.onPostUpload(e,s),n.sendEventAnalytics("event","Photos","UploadPhoto","Webcam")}}),i.close()})}})},onClose:function(e){o(".js-img",e).webcam("destroy")}});i.open(),r.preventDefault()})},showUpload:function(e){var t=this,r=null;o("#userpic").fileapi({url:window.api_endpoint+"/api/users/"+window.user_id+"/photo?access_token="+window.token,accept:"image/*",paramName:"image",imageOriginal:!1,duplicate:!1,imageSize:{minWidth:200,minHeight:200},onFileComplete:function(n,r){var i=r.result;t.onPostUpload(e,i)},elements:{active:{show:".js-upload",hide:".js-browse"},preview:{el:".js-preview",width:200,height:200},progress:".progress"},onSelect:function(e,r){var i=r.files[0];i||(i=r.other[0]);if(i.errors){t.showError(i.errors);return}!FileAPI.support.transform||i&&(o(".progress").show(),o("#popup").modal({closeOnEsc:!0,closeOnOverlayClick:!1,onOpen:function(e){o(e).on("click",".js-upload",function(){o.modal().close(),o("#userpic").fileapi("upload"),n.sendEventAnalytics("event","Photos","UploadPhoto","File")}),o(".js-img",e).cropper({file:i,bgColor:"#fff",maxSize:[o(window).width()-100,o(window).height()-100],minSize:[200,200],selection:"90%",onSelect:function(e){o("#userpic").fileapi("crop",i,e)}})}}).open())}})}})}),e.PhotosApp.Upload.View});