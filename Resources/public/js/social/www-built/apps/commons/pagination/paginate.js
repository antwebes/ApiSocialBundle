/*
  backbone.paginator 2.0.0
  http://github.com/backbone-paginator/backbone.paginator

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/

!function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define("paginator",["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,n=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,n}}}(function(e,t){function n(t,n){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+n+"` must be a finite integer");return t}function r(e){for(var t,n,r,i,s={},o=decodeURIComponent,u=e.split("&"),a=0,f=u.length;f>a;a++){var l=u[a];t=l.split("="),n=t[0],r=t[1]||!0,n=o(n),r=o(r),i=s[n],d(i)?i.push(r):s[n]=i?[i,r]:r}return s}function i(e,t,n){var r=e._events[t];if(r&&r.length){var i=r[r.length-1],s=i.callback;i.callback=function(){try{s.apply(this,arguments),n()}catch(e){throw e}finally{i.callback=s}}}else n()}var s=e.extend,o=e.omit,u=e.clone,a=e.each,f=e.pick,l=e.contains,c=e.isEmpty,h=e.pairs,p=e.invert,d=e.isArray,v=e.isFunction,m=e.isObject,g=e.keys,y=e.isUndefined,b=Math.ceil,w=Math.floor,E=Math.max,S=t.Collection.prototype,x=/[\s'"]/g,T=/[<>\s'"]/g,N=t.PageableCollection=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},constructor:function(e,t){S.constructor.apply(this,arguments),t=t||{};var n=this.mode=t.mode||this.mode||C.mode,r=s({},C.queryParams,this.queryParams,t.queryParams||{});r.directions=s({},C.queryParams.directions,this.queryParams.directions,r.directions||{}),this.queryParams=r;var i=this.state=s({},C.state,this.state,t.state||{});i.currentPage=null==i.currentPage?i.firstPage:i.currentPage,d(e)||(e=e?[e]:[]),e=e.slice(),"server"==n||null!=i.totalRecords||c(e)||(i.totalRecords=e.length),this.switchMode(n,s({fetch:!1,resetState:!1,models:e},t));var o=t.comparator;if(i.sortKey&&!o&&this.setSorting(i.sortKey,i.order,t),"server"!=n){var a=this.fullCollection;o&&t.full&&(this.comparator=null,a.comparator=o),t.full&&a.sort(),e&&!c(e)&&(this.reset(e,s({silent:!0},t)),this.getPage(i.currentPage),e.splice.apply(e,[0,e.length].concat(this.models)))}this._initState=u(this.state)},_makeFullCollection:function(e,n){var r,i,s,o=["url","model","sync","comparator"],u=this.constructor.prototype,a={};for(r=0,i=o.length;i>r;r++)s=o[r],y(u[s])||(a[s]=u[s]);var f=new(t.Collection.extend(a))(e,n);for(r=0,i=o.length;i>r;r++)s=o[r],this[s]!==u[s]&&(f[s]=this[s]);return f},_makeCollectionEventHandler:function(e,t){return function(n,r,o,f){var l=e._handlers;a(g(l),function(n){var r=l[n];e.off(n,r),t.off(n,r)});var c=u(e.state),h=c.firstPage,p=0===h?c.currentPage:c.currentPage-1,d=c.pageSize,v=p*d,m=v+d;if("add"==n){var w,E,S,x,f=f||{};if(o==t)E=t.indexOf(r),E>=v&&m>E&&(x=e,w=S=E-v);else{w=e.indexOf(r),E=v+w,x=t;var S=y(f.at)?E:f.at+v}if(f.onRemove||(++c.totalRecords,delete f.onRemove),e.state=e._checkState(c),x){x.add(r,s({},f||{},{at:S}));var T=w>=d?r:!y(f.at)&&m>S&&e.length>d?e.at(d):null;T&&i(o,n,function(){e.remove(T,{onAdd:!0})})}}if("remove"==n)if(f.onAdd)delete f.onAdd;else{if(--c.totalRecords){var N=c.totalPages=b(c.totalRecords/d);c.lastPage=0===h?N-1:N||h,c.currentPage>N&&(c.currentPage=c.lastPage)}else c.totalRecords=null,c.totalPages=null;e.state=e._checkState(c);var C,k=f.index;o==e?((C=t.at(m))?i(e,n,function(){e.push(C,{onRemove:!0})}):!e.length&&c.totalRecords&&e.reset(t.models.slice(v-d,m-d),s({},f,{parse:!1})),t.remove(r)):k>=v&&m>k&&((C=t.at(m-1))&&i(e,n,function(){e.push(C,{onRemove:!0})}),e.remove(r),!e.length&&c.totalRecords&&e.reset(t.models.slice(v-d,m-d),s({},f,{parse:!1})))}if("reset"==n)if(f=o,o=r,o==e&&null==f.from&&null==f.to){var L=t.models.slice(0,v),A=t.models.slice(v+e.models.length);t.reset(L.concat(e.models).concat(A),f)}else o==t&&((c.totalRecords=t.models.length)||(c.totalRecords=null,c.totalPages=null),"client"==e.mode&&(c.lastPage=c.currentPage=c.firstPage),e.state=e._checkState(c),e.reset(t.models.slice(v,m),s({},f,{parse:!1})));"sort"==n&&(f=o,o=r,o===t&&e.reset(t.models.slice(v,m),s({},f,{parse:!1}))),a(g(l),function(n){var r=l[n];a([e,t],function(e){e.on(n,r);var t=e._events[n]||[];t.unshift(t.pop())})})}},_checkState:function(e){var t=this.mode,r=this.links,i=e.totalRecords,s=e.pageSize,o=e.currentPage,u=e.firstPage,a=e.totalPages;if(null!=i&&null!=s&&null!=o&&null!=u&&("infinite"==t?r:!0)){if(i=n(i,"totalRecords"),s=n(s,"pageSize"),o=n(o,"currentPage"),u=n(u,"firstPage"),1>s)throw new RangeError("`pageSize` must be >= 1");if(a=e.totalPages=b(i/s),0>u||u>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===u?E(0,a-1):a||u,"infinite"==t){if(!r[o+""])throw new RangeError("No link found for page "+o)}else if(u>o||a>0&&(u?o>a:o>=a))throw new RangeError("`currentPage` must be firstPage <= currentPage "+(u?">":">=")+" totalPages if "+u+"-based. Got "+o+".")}return e},setPageSize:function(e,t){e=n(e,"pageSize"),t=t||{first:!1};var r=this.state,i=b(r.totalRecords/e),u=i?E(r.firstPage,w(i*r.currentPage/r.totalPages)):r.firstPage;return r=this.state=this._checkState(s({},r,{pageSize:e,currentPage:t.first?r.firstPage:u,totalPages:i})),this.getPage(r.currentPage,o(t,["first"]))},switchMode:function(t,n){if(!l(["server","client","infinite"],t))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');n=n||{fetch:!0,resetState:!0};var r=this.state=n.resetState?u(this._initState):this._checkState(s({},this.state));this.mode=t;var i,f=this,c=this.fullCollection,h=this._handlers=this._handlers||{};if("server"==t||c)"server"==t&&c&&(a(g(h),function(e){i=h[e],f.off(e,i),c.off(e,i)}),delete this._handlers,this._fullComparator=c.comparator,delete this.fullCollection);else{c=this._makeFullCollection(n.models||[],n),c.pageableCollection=this,this.fullCollection=c;var p=this._makeCollectionEventHandler(this,c);a(["add","remove","reset","sort"],function(t){h[t]=i=e.bind(p,{},t),f.on(t,i),c.on(t,i)}),c.comparator=this._fullComparator}if("infinite"==t)for(var d=this.links={},v=r.firstPage,m=b(r.totalRecords/r.pageSize),y=0===v?E(0,m-1):m||v,w=r.firstPage;y>=w;w++)d[w]=this.url;else this.links&&delete this.links;return n.fetch?this.fetch(o(n,"fetch","resetState")):this},hasPreviousPage:function(){var e=this.state,t=e.currentPage;return"infinite"!=this.mode?t>e.firstPage:!!this.links[t-1]},hasNextPage:function(){var e=this.state,t=this.state.currentPage;return"infinite"!=this.mode?t<e.lastPage:!!this.links[t+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var r=this.mode,i=this.fullCollection;t=t||{fetch:!1};var u=this.state,a=u.firstPage,f=u.currentPage,l=u.lastPage,h=u.pageSize,p=e;switch(e){case"first":p=a;break;case"prev":p=f-1;break;case"next":p=f+1;break;case"last":p=l;break;default:p=n(e,"index")}this.state=this._checkState(s({},u,{currentPage:p})),t.from=f,t.to=p;var d=(0===a?p:p-1)*h,v=i&&i.length?i.models.slice(d,d+h):[];return"client"!=r&&("infinite"!=r||c(v))||t.fetch?("infinite"==r&&(t.url=this.links[p]),this.fetch(o(t,"fetch"))):(this.reset(v,o(t,"fetch")),this)},getPageByOffset:function(e,t){if(0>e)throw new RangeError("`offset must be > 0`");e=n(e);var r=w(e/this.state.pageSize);return 0!==this.state.firstPage&&r++,r>this.state.lastPage&&(r=this.state.lastPage),this.getPage(r,t)},sync:function(e,n,r){var i=this;if("infinite"==i.mode){var o=r.success,u=i.state.currentPage;r.success=function(e,t,n){var a=i.links,f=i.parseLinks(e,s({xhr:n},r));f.first&&(a[i.state.firstPage]=f.first),f.prev&&(a[u-1]=f.prev),f.next&&(a[u+1]=f.next),o&&o(e,t,n)}}return(S.sync||t.sync).call(i,e,n,r)},parseLinks:function(e,t){var n={},r=t.xhr.getResponseHeader("Link");if(r){var i=["first","prev","next"];a(r.split(","),function(e){var t=e.split(";"),r=t[0].replace(T,""),s=t.slice(1);a(s,function(e){var t=e.split("="),s=t[0].replace(x,""),o=t[1].replace(x,"");"rel"==s&&l(i,o)&&(n[o]=r)})})}return n},parse:function(e,t){var n=this.parseState(e,u(this.queryParams),u(this.state),t);return n&&(this.state=this._checkState(s({},this.state,n))),this.parseRecords(e,t)},parseState:function(t,n,r){if(t&&2===t.length&&m(t[0])&&d(t[1])){var i=u(r),s=t[0];return a(h(o(n,"directions")),function(t){var n=t[0],r=t[1],o=s[r];y(o)||e.isNull(o)||(i[n]=s[r])}),s.order&&(i.order=1*p(n.directions)[s.order]),i}},parseRecords:function(e){return e&&2===e.length&&m(e[0])&&d(e[1])?e[1]:e},fetch:function(e){e=e||{};var t=this._checkState(this.state),n=this.mode;"infinite"!=n||e.url||(e.url=this.links[t.currentPage]);var i=e.data||{},a=e.url||this.url||"";v(a)&&(a=a.call(this));var l=a.indexOf("?");-1!=l&&(s(i,r(a.slice(l+1))),a=a.slice(0,l)),e.url=a,e.data=i;var c,p,d,m,b="client"==this.mode?f(this.queryParams,"sortKey","order"):o(f(this.queryParams,g(C.queryParams)),"directions"),w=h(b),E=u(this);for(c=0;c<w.length;c++)p=w[c],d=p[0],m=p[1],m=v(m)?m.call(E):m,null!=t[d]&&null!=m&&(i[m]=t[d]);if(t.sortKey&&t.order){var x=v(b.order)?b.order.call(E):b.order;i[x]=this.queryParams.directions[t.order+""]}else t.sortKey||delete i[b.order];var T=h(o(this.queryParams,g(C.queryParams)));for(c=0;c<T.length;c++)p=T[c],m=p[1],m=v(m)?m.call(E):m,null!=m&&(i[p[0]]=m);if("server"!=n){var N=this,k=this.fullCollection,L=e.success;return e.success=function(t,r,i){i=i||{},y(e.silent)?delete i.silent:i.silent=e.silent;var o=t.models;"client"==n?k.reset(o,i):(k.add(o,s({at:k.length},s(i,{parse:!1}))),N.trigger("reset",N,i)),L&&L(t,r,i)},S.fetch.call(this,s({},e,{silent:!0}))}return S.fetch.call(this,e)},_makeComparator:function(e,t,n){var r=this.state;return e=e||r.sortKey,t=t||r.order,e&&t?(n||(n=function(e,t){return e.get(t)}),function(r,i){var s,o=n(r,e),u=n(i,e);return 1===t&&(s=o,o=u,u=s),o===u?0:u>o?-1:1}):void 0},setSorting:function(e,t,n){var r=this.state;r.sortKey=e,r.order=t=t||r.order;var i=this.fullCollection,o=!1,u=!1;e||(o=u=!0);var a=this.mode;n=s({side:"client"==a?a:"server",full:!0},n);var f=this._makeComparator(e,t,n.sortValue),l=n.full,c=n.side;return"client"==c?l?(i&&(i.comparator=f),o=!0):(this.comparator=f,u=!0):"server"!=c||l||(this.comparator=f),o&&(this.comparator=null),u&&i&&(i.comparator=null),this}}),C=N.prototype;return N}),define("text!apps/commons/pagination/templates/pagination_layout_template.html",[],function(){return'<script>\n	<div class="row list_region"></div>\n	<div class="row pages"></div>\n</script>'}),define("text!apps/commons/pagination/templates/pages_template.html",[],function(){return'<%\nvar currentPage = state.currentPage;\nvar firstPage = state.firstPage;\n%>\n\n<% if (totalPages > 1) { %>\n<div class="text-center">\n  <ul class="pagination">\n    <% if (currentPage > firstPage) { %>\n      <li><a href="#" class="prev">&laquo; Anterior</a></li>\n    <% } %>\n\n    <% var start = currentPage - 2 %>\n    <% var final = currentPage + 2 %>\n    <% start = start < 1 ? 1 : start %>\n    <% final = final >= totalPages ? totalPages : final %>\n\n    <% if (firstPage != currentPage && start >= 2) { %>\n      <li><a href="#" class="page"><%- firstPage%></a></li>\n      <li class="disabled"><a>...</a></li>\n    <% } %>\n\n    <% for (var p = start; p <= final; p++) { %>\n      <% if (currentPage === p) { %>\n        <li class="active"><a class="page"><%- p %> <span class="sr-only">(actual)</span></a></li>\n      <% } else { %>\n        <li><a href="#" class="page"><%- p %></a></li>\n      <% } %>\n    <% } %>\n\n    <% if (totalPages != currentPage && totalPages - final > 0) { %>\n      <li class="disabled"><a>...</a></li>\n      <li><a href="#" class="page"><%- totalPages%></a></li>\n    <% } %>\n    \n    <% if (currentPage < totalPages) { %>\n      <li><a href="#" class="next">Siguiente &raquo;</a></li>\n    <% } %>\n  </ul>\n</div>\n<% } %>'}),define("apps/commons/pagination/paginate",["app","paginator","text!apps/commons/pagination/templates/pagination_layout_template.html","text!apps/commons/pagination/templates/pages_template.html"],function(e,t,n,r){return e.module("CommonsApp.Pagination",function(e,i,s,o,u,a){e.Collection=t.extend({mode:"server",queryParams:{currentPage:null,pageSize:null,totalPages:null,limit:function(){return 100},offset:function(){return(this.state.currentPage-1)*this.state.pageSize}},state:{pageSize:12},initialize:function(e){if(typeof e!="undefined"&&e.url){var t=e.url.split("?");this.url=t[0];if(t.length>1){var n=t[1].split("&"),r,i,s;for(var o=0;o<n.length;o++)r=n[o].split("="),i=r.shift(),s=r.join("="),this.queryParams[i]=s}}},parse:function(e){return this.totalPages=Math.ceil(e.total/this.state.pageSize),e.resources.slice(0,this.state.pageSize)},sync:function(e,n,r){var i=r.success,s=this,o=r.data.offset;r.success=function(e,t,r){s._json=e,i(s._json,n,{})};if(s._json&&s.isOffsetInCollection(o)){var u=a.clone(s._json),f=o-u.offset;u.resources=a.clone(u.resources).slice(f,f+this.state.pageSize),i(u,n,{})}else t.prototype.sync.call(this,e,n,r)},isOffsetInCollection:function(e){var t=e>=this._json.offset&&e<=this._json.offset+this._json.count,n=e-this._json.offset+this.state.pageSize>this._json.count;return t&&!n}}),e.Layout=o.Layout.extend({template:n,regions:{list_region:".list_region",pages_region:".pages"}}),e.PaginationView=o.ItemView.extend({template:a.template(r,this.collection),className:"pagination pagination-centered",events:{"click .prev":"gotoPrev","click .next":"gotoNext","click .page":"gotoPage"},gotoPrev:function(){return this.trigger("goToPrev",this.collection.state.currentPage-1),this.collection.getPreviousPage(),this.render(),this.scrollToTop(),!1},gotoPage:function(e){var t=parseInt(u(e.target).text());return this.trigger("goToPage",t),this.collection.getPage(t),this.render(),this.scrollToTop(),!1},gotoNext:function(e){return this.collection.getNextPage(),this.trigger("goToPage",this.collection.state.currentPage),this.render(),this.scrollToTop(),!1},scrollToTop:function(){this.options.avoidScrollOnPageChange||u("html, body").animate({scrollTop:0},"slow")},serializeData:function(){return this.collection}})}),e.CommonsApp.Pagination});