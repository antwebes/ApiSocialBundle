define(["app"],function(e){return e.module("Entities",function(e,t,n,r,i,s){e.Thread=n.Model.extend({urlRoot:window.api_endpoint+"/api/users/"+window.user_id+"/threads/inbox",schema:{subject:{validators:["required"]}}}),e.ThreadCollection=n.Collection.extend({url:window.api_endpoint+"/api/users/"+window.user_id+"/threads/",model:e.Thread,initialize:function(e){this.url=this.url+e.box}}),e.NewThread=n.Model.extend({urlRoot:window.api_endpoint+"/api/users/"+window.user_id+"/threads",schema:{recipient:{validators:[{type:"required",message:t.request("trans","messages::required")}],editorAttrs:{id:"form-field-recipient",type:"email",placeholder:t.request("trans","messages::recipient")}},subject:{validators:[{type:"required",message:t.request("trans","messages::required")}],editorAttrs:{placeholder:t.request("trans","messages::subject")}},body:{validators:[{type:"required",message:t.request("trans","messages::required")}],type:"TextArea",editorClass:"wysiwyg-editor",editorAttrs:{cols:"100",rows:"10",placeholder:t.request("trans","messages::message")}}},toJSON:function(){var e=n.Model.prototype.toJSON.apply(this,arguments);return{message:e}}});var o=function(t){var n=new e.ThreadCollection({box:t}),r=i.Deferred();n.fetch({success:function(e){r.resolve(e)}});var s=r.promise();return s},u={getThreads:function(){return o("inbox")},getUnreadedThreads:function(){var e=o("inbox"),t=i.Deferred();i.when(e).done(function(e){var n=e.filter(function(e){return!e.get("is_readed")});t.resolve(n)});var n=t.promise();return n},getSentThreads:function(){return o("sent")},deleteThread:function(t){var n=i.Deferred(),r=new e.Thread;r.set("id",t.id),r.urlRoot=window.api_endpoint+"/api/users/"+window.user_id+"/threads/",r.destroy({success:function(){n.resolve()}});var s=n.promise();return s}};t.reqres.setHandler("thread:entities",function(){return u.getThreads()}),t.reqres.setHandler("thread:entities:sent",function(){return u.getSentThreads()}),t.reqres.setHandler("thread:entities:unreaded",function(){return u.getUnreadedThreads()}),t.reqres.setHandler("thread:delete",function(e){return u.deleteThread(e)})}),e.Entities});