define(["app","entities/user"],function(e){return e.module("Entities.Channel",function(e,t,n,r,i,s){e.Channel=n.Model.extend({urlRoot:window.api_endpoint+"/api/channels",schema:{channel_type:{title:"Channel Type",type:"Select",options:function(e){var t=[],n=i.ajax({dataType:"json",url:window.api_endpoint+"/api/channelstype",success:function(n){s.each(n.resources,function(e){t.push({val:e.name,label:e.name})}),e(t)},error:function(t){e(["error"])}})}},name:{validators:["required"]},irc_channel:{validators:["required",{type:"regexp",match:!1,regexp:/[\x00\x07\n\r ,]/,message:"Enter a valid ircChannel!"}]},description:{type:"TextArea",validators:["required"]},language:{type:"Select",options:["es","en","pt"]}},changePhoto:function(e){i.ajax({dataType:"json",type:"PATCH",data:{photo_id:e},url:window.api_endpoint+"/api/users/"+window.user_id+"/channels/"+this.get("id")+"/photo"})},addModerator:function(e,t){var n=i.Deferred();return i.ajax({dataType:"json",type:"POST",url:window.api_endpoint+"/api/channels/"+this.get("id")+"/moderators",data:{user_id:e,level:t},success:function(){n.resolve({})},error:function(e,t,r){n.reject(e,t,r)}}),n.promise()},deleteModerator:function(e){var t=i.Deferred();return i.ajax({dataType:"json",type:"delete",url:window.api_endpoint+"/api/channels/"+this.get("id")+"/moderators/"+e.get("id"),success:function(){t.resolve({})}}),t.promise()}}),e.ChannelCollection=n.Collection.extend({url:window.api_endpoint+"/api/channels",model:e.Channel,initialize:function(e){e&&(typeof e.parameters=="undefined"?this.url=this.url+"?limit=36":this.url=this.url+e.parameters)},parse:function(e){return e.resources}});var o={getChannelEntity:function(r){var s=new e.Channel({id:r}),o=i.Deferred();return s.fetch({success:function(e){e.creator=t.request("user:entity:new",e.get("owner")),e.creator.url=function(){return e.attributes._links.owner.href};var r=e.get("fans")||[];e.set("fans",new n.Collection(r));var i=e.get("moderators")||[];e.set("moderators",new n.Collection(i));var s=e.get("channels")||[];e.set("childrens",new n.Collection(s)),o.resolve(e)},error:function(e,t,n){o.reject(t)}}),o.promise()},getChannelEntities:function(t){var n=new e.ChannelCollection({parameters:t}),r=i.Deferred();n.fetch({reset:!0,success:function(e){r.resolve(e)},error:function(e,t,n){r.reject(t)}});var s=r.promise();return i.when(s).done(function(e){e.length===0&&e.reset(models)}),s},getOutstandingChannelEntities:function(){var e=i.Deferred(),t=s.map(window.outstanding_channels,o.getChannelEntity);return i.when.apply(i,t).done(function(){var t=Array.prototype.slice.call(arguments,0);e.resolve(new n.Collection(t))}).fail(function(t){e.reject(t)}),e.promise()},addModerator:function(e,t,n){return e.addModerator(t,n)},deleteModerator:function(e,t){return e.deleteModerator(t)}};t.reqres.setHandler("channel:entity",function(e){return o.getChannelEntity(e)}),t.reqres.setHandler("channel:entity:new",function(t){return new e.Channel(t)}),t.reqres.setHandler("channel:entities",function(e){return o.getChannelEntities(e)}),t.reqres.setHandler("channel:entities:outstanding",function(e){return o.getOutstandingChannelEntities()}),t.reqres.setHandler("channel:addModerator",function(e,t,n){return o.addModerator(e,t,n)}),t.reqres.setHandler("channel:deleteModerator",function(e,t){return o.deleteModerator(e,t)})}),e.Entities.Channel});