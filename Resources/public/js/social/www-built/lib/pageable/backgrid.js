/*!
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2014 Jimmy Yuen Ho Wong and contributors <wyuenho@gmail.com>
  Licensed under the MIT license.
*/

/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT license.
*/

// Copyright 2009, 2010 Kristopher Michael Kowal
// https://github.com/kriskowal/es5-shim
// ES5 15.5.4.20
// http://es5.github.com/#x15.5.4.20

(function(e){typeof exports=="object"?module.exports=e(module.exports,require("underscore"),require("backbone")):e(this,this._,this.Backbone)})(function(e,t,n){function o(e,t,n){var r=t-(e+"").length;r=r<0?0:r;var i="";for(var s=0;s<r;s++)i+=n;return i+e}var r="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||r.trim()){r="["+r+"]";var i=new RegExp("^"+r+r+"*"),s=new RegExp(r+r+"*$");String.prototype.trim=function(){if(this===undefined||this===null)throw new TypeError("can't convert "+this+" to object");return String(this).replace(i,"").replace(s,"")}}var u=n.$,a=e.Backgrid={Extension:{},resolveNameToClass:function(e,n){if(t.isString(e)){var r=t.map(e.split("-"),function(e){return e.slice(0,1).toUpperCase()+e.slice(1)}).join("")+n,i=a[r]||a.Extension[r];if(t.isUndefined(i))throw new ReferenceError("Class '"+r+"' not found");return i}return e},callByNeed:function(){var e=arguments[0];if(!t.isFunction(e))return e;var n=arguments[1],r=[].slice.call(arguments,2);return e.apply(n,r+""?r:[])}};t.extend(a,n.Events);var f=a.Command=function(e){t.extend(this,{altKey:!!e.altKey,"char":e["char"],charCode:e.charCode,ctrlKey:!!e.ctrlKey,key:e.key,keyCode:e.keyCode,locale:e.locale,location:e.location,metaKey:!!e.metaKey,repeat:!!e.repeat,shiftKey:!!e.shiftKey,which:e.which})};t.extend(f.prototype,{moveUp:function(){return this.keyCode==38},moveDown:function(){return this.keyCode===40},moveLeft:function(){return this.shiftKey&&this.keyCode===9},moveRight:function(){return!this.shiftKey&&this.keyCode===9},save:function(){return this.keyCode===13},cancel:function(){return this.keyCode===27},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var l=a.CellFormatter=function(){};t.extend(l.prototype,{fromRaw:function(e,t){return e},toRaw:function(e,t){return e}});var c=a.NumberFormatter=function(e){t.extend(this,this.defaults,e||{});if(this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};c.prototype=new l,t.extend(c.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e,n){if(t.isNull(e)||t.isUndefined(e))return"";e=e.toFixed(~~this.decimals);var r=e.split("."),i=r[0],s=r[1]?(this.decimalSeparator||".")+r[1]:"";return i.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+s},toRaw:function(e,n){e=e.trim();if(e==="")return null;var r="",i=e.split(this.orderSeparator);for(var s=0;s<i.length;s++)r+=i[s];var o=r.split(this.decimalSeparator);r="";for(var s=0;s<o.length;s++)r=r+o[s]+".";r[r.length-1]==="."&&(r=r.slice(0,r.length-1));var u=(r*1).toFixed(~~this.decimals)*1;if(t.isNumber(u)&&!t.isNaN(u))return u}});var h=a.PercentFormatter=function(){a.NumberFormatter.apply(this,arguments)};h.prototype=new a.NumberFormatter,t.extend(h.prototype,{defaults:t.extend({},c.prototype.defaults,{multiplier:1,symbol:"%"}),fromRaw:function(e,t){var n=[].slice.call(arguments,1);return n.unshift(e*this.multiplier),(c.prototype.fromRaw.apply(this,n)||"0")+this.symbol},toRaw:function(e,n){var r=e.split(this.symbol);if(r&&r[0]&&r[1]===""||r[1]==null){var i=c.prototype.toRaw.call(this,r[0]);return t.isUndefined(i)?i:i/this.multiplier}}});var p=a.DatetimeFormatter=function(e){t.extend(this,this.defaults,e||{});if(!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};p.prototype=new l,t.extend(p.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(e,n){if((e+"").trim()==="")return null;var r,i=null;if(t.isNumber(e)){var s=new Date(e);r=o(s.getUTCFullYear(),4,0)+"-"+o(s.getUTCMonth()+1,2,0)+"-"+o(s.getUTCDate(),2,0),i=o(s.getUTCHours(),2,0)+":"+o(s.getUTCMinutes(),2,0)+":"+o(s.getUTCSeconds(),2,0)}else{e=e.trim();var u=e.split(this.ISO_SPLITTER_RE)||[];r=this.DATE_RE.test(u[0])?u[0]:"",i=r&&u[1]?u[1]:this.TIME_RE.test(u[0])?u[0]:""}var a=this.DATE_RE.exec(r)||[],f=this.TIME_RE.exec(i)||[];if(n){if(this.includeDate&&t.isUndefined(a[0]))return;if(this.includeTime&&t.isUndefined(f[0]))return;if(!this.includeDate&&r)return;if(!this.includeTime&&i)return}var s=new Date(Date.UTC(a[1]*1||0,a[2]*1-1||0,a[3]*1||0,f[1]*1||null,f[2]*1||null,f[3]*1||null,f[5]*1||null)),l="";return this.includeDate&&(l=o(s.getUTCFullYear(),4,0)+"-"+o(s.getUTCMonth()+1,2,0)+"-"+o(s.getUTCDate(),2,0)),this.includeTime&&(l=l+(this.includeDate?"T":"")+o(s.getUTCHours(),2,0)+":"+o(s.getUTCMinutes(),2,0)+":"+o(s.getUTCSeconds(),2,0),this.includeMilli&&(l=l+"."+o(s.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(l+="Z"),l},fromRaw:function(e,n){return t.isNull(e)||t.isUndefined(e)?"":this._convert(e)},toRaw:function(e,t){return this._convert(e,!0)}});var d=a.StringFormatter=function(){};d.prototype=new l,t.extend(d.prototype,{fromRaw:function(e,n){return t.isUndefined(e)||t.isNull(e)?"":e+""}});var v=a.EmailFormatter=function(){};v.prototype=new l,t.extend(v.prototype,{toRaw:function(e,n){var r=e.trim().split("@");if(r.length===2&&t.all(r))return e}});var m=a.SelectFormatter=function(){};m.prototype=new l,t.extend(m.prototype,{fromRaw:function(e,n){return t.isArray(e)?e:e!=null?[e]:[]}});var g=a.CellEditor=n.View.extend({initialize:function(e){this.formatter=e.formatter,this.column=e.column,this.column instanceof D||(this.column=new D(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(e,t){return(t==null||t.get("name")==this.column.get("name"))&&this.$el.focus(),this}}),y=a.InputCellEditor=g.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){y.__super__.initialize.apply(this,arguments),e.placeholder&&this.$el.attr("placeholder",e.placeholder)},render:function(){var e=this.model;return this.$el.val(this.formatter.fromRaw(e.get(this.column.get("name")),e)),this},saveOrCancel:function(e){var n=this.formatter,r=this.model,i=this.column,s=new f(e),o=e.type==="blur";if(s.moveUp()||s.moveDown()||s.moveLeft()||s.moveRight()||s.save()||o){e.preventDefault(),e.stopPropagation();var u=this.$el.val(),a=n.toRaw(u,r);t.isUndefined(a)?r.trigger("backgrid:error",r,i,u):(r.set(i.get("name"),a),r.trigger("backgrid:edited",r,i,s))}else s.cancel()&&(e.stopPropagation(),r.trigger("backgrid:edited",r,i,s))},postRender:function(e,t){if(t==null||t.get("name")==this.column.get("name"))if(this.$el.css("text-align")==="right"){var n=this.$el.val();this.$el.focus().val(null).val(n)}else this.$el.focus();return this}}),b=a.Cell=n.View.extend({tagName:"td",formatter:l,editor:y,events:{click:"enterEditMode"},initialize:function(e){this.column=e.column,this.column instanceof D||(this.column=new D(this.column));var n=this.column,r=this.model,i=this.$el,s=a.resolveNameToClass(n.get("formatter")||this.formatter,"Formatter");!t.isFunction(s.fromRaw)&&!t.isFunction(s.toRaw)&&(s=new s),this.formatter=s,this.editor=a.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(r,"change:"+n.get("name"),function(){i.hasClass("editor")||this.render()}),this.listenTo(r,"backgrid:error",this.renderError),this.listenTo(n,"change:editable change:sortable change:renderable",function(e){var t=e.changedAttributes();for(var n in t)t.hasOwnProperty(n)&&i.toggleClass(n,t[n])}),a.callByNeed(n.editable(),n,r)&&i.addClass("editable"),a.callByNeed(n.sortable(),n,r)&&i.addClass("sortable"),a.callByNeed(n.renderable(),n,r)&&i.addClass("renderable")},render:function(){this.$el.empty();var e=this.model;return this.$el.text(this.formatter.fromRaw(e.get(this.column.get("name")),e)),this.delegateEvents(),this},enterEditMode:function(){var e=this.model,t=this.column,n=a.callByNeed(t.editable(),t,e);n&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),e.trigger("backgrid:edit",e,t,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),e.trigger("backgrid:editing",e,t,this,this.currentEditor))},renderError:function(e,t){(t==null||t.get("name")==this.column.get("name"))&&this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),b.__super__.remove.apply(this,arguments)}}),w=a.StringCell=b.extend({className:"string-cell",formatter:d}),E=a.UriCell=b.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(e){E.__super__.initialize.apply(this,arguments),this.title=e.title||this.title,this.target=e.target||this.target},render:function(){this.$el.empty();var e=this.model.get(this.column.get("name")),t=this.formatter.fromRaw(e,this.model);return this.$el.append(u("<a>",{tabIndex:-1,href:e,title:this.title||t,target:this.target}).text(t)),this.delegateEvents(),this}}),S=a.EmailCell=w.extend({className:"email-cell",formatter:v,render:function(){this.$el.empty();var e=this.model,t=this.formatter.fromRaw(e.get(this.column.get("name")),e);return this.$el.append(u("<a>",{tabIndex:-1,href:"mailto:"+t,title:t}).text(t)),this.delegateEvents(),this}}),x=a.NumberCell=b.extend({className:"number-cell",decimals:c.prototype.defaults.decimals,decimalSeparator:c.prototype.defaults.decimalSeparator,orderSeparator:c.prototype.defaults.orderSeparator,formatter:c,initialize:function(e){x.__super__.initialize.apply(this,arguments);var t=this.formatter;t.decimals=this.decimals,t.decimalSeparator=this.decimalSeparator,t.orderSeparator=this.orderSeparator}}),T=a.IntegerCell=x.extend({className:"integer-cell",decimals:0}),N=a.PercentCell=x.extend({className:"percent-cell",multiplier:h.prototype.defaults.multiplier,symbol:h.prototype.defaults.symbol,formatter:h,initialize:function(){N.__super__.initialize.apply(this,arguments);var e=this.formatter;e.multiplier=this.multiplier,e.symbol=this.symbol}}),C=a.DatetimeCell=b.extend({className:"datetime-cell",includeDate:p.prototype.defaults.includeDate,includeTime:p.prototype.defaults.includeTime,includeMilli:p.prototype.defaults.includeMilli,formatter:p,initialize:function(e){C.__super__.initialize.apply(this,arguments);var n=this.formatter;n.includeDate=this.includeDate,n.includeTime=this.includeTime,n.includeMilli=this.includeMilli;var r=this.includeDate?"YYYY-MM-DD":"";r+=this.includeDate&&this.includeTime?"T":"",r+=this.includeTime?"HH:mm:ss":"",r+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:t.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:r})})}}),k=a.DateCell=C.extend({className:"date-cell",includeTime:!1}),L=a.TimeCell=C.extend({className:"time-cell",includeDate:!1}),A=a.BooleanCellEditor=g.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var e=this.model,t=this.formatter.fromRaw(e.get(this.column.get("name")),e);return this.$el.prop("checked",t),this},enterOrExitEditMode:function(e){if(!this.mouseDown){var t=this.model;t.trigger("backgrid:edited",t,this.column,new f(e))}},saveOrCancel:function(e){var t=this.model,n=this.column,r=this.formatter,i=new f(e);if(i.passThru()&&e.type!="change")return!0;i.cancel()&&(e.stopPropagation(),t.trigger("backgrid:edited",t,n,i));var s=this.$el;if(i.save()||i.moveLeft()||i.moveRight()||i.moveUp()||i.moveDown()){e.preventDefault(),e.stopPropagation();var o=r.toRaw(s.prop("checked"),t);t.set(n.get("name"),o),t.trigger("backgrid:edited",t,n,i)}else if(e.type=="change"){var o=r.toRaw(s.prop("checked"),t);t.set(n.get("name"),o),s.focus()}}}),O=a.BooleanCell=b.extend({className:"boolean-cell",editor:A,events:{click:"enterEditMode"},render:function(){this.$el.empty();var e=this.model,t=this.column,n=a.callByNeed(t.editable(),t,e);return this.$el.append(u("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(e.get(t.get("name")),e),disabled:!n})),this.delegateEvents(),this}}),M=a.SelectCellEditor=g.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:t.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>',null,{variable:null}),setOptionValues:function(e){this.optionValues=e,this.optionValues=t.result(this,"optionValues")},setMultiple:function(e){this.multiple=e,this.$el.prop("multiple",e)},_renderOptions:function(e,n){var r="";for(var i=0;i<e.length;i++)r+=this.template({text:e[i][0],value:e[i][1],selected:t.indexOf(n,e[i][1])>-1});return r},render:function(){this.$el.empty();var e=t.result(this,"optionValues"),n=this.model,r=this.formatter.fromRaw(n.get(this.column.get("name")),n);if(!t.isArray(e))throw new TypeError("optionValues must be an array");var i=null,s=null,i=null,o=null,a=null;for(var f=0;f<e.length;f++){var i=e[f];if(t.isArray(i))s=i[0],i=i[1],this.$el.append(this.template({text:s,value:i,selected:t.indexOf(r,i)>-1}));else{if(!t.isObject(i))throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");o=i.name,a=u("<optgroup></optgroup>",{label:o}),a.append(this._renderOptions.call(this,i.values,r)),this.$el.append(a)}}return this.delegateEvents(),this},save:function(e){var t=this.model,n=this.column;t.set(n.get("name"),this.formatter.toRaw(this.$el.val(),t))},close:function(e){var t=this.model,n=this.column,r=new f(e);if(r.cancel())e.stopPropagation(),t.trigger("backgrid:edited",t,n,new f(e));else if(r.save()||r.moveLeft()||r.moveRight()||r.moveUp()||r.moveDown()||e.type=="blur")e.preventDefault(),e.stopPropagation(),this.save(e),t.trigger("backgrid:edited",t,n,new f(e))}}),_=a.SelectCell=b.extend({className:"select-cell",editor:M,multiple:!1,formatter:m,optionValues:undefined,delimiter:", ",initialize:function(e){_.__super__.initialize.apply(this,arguments),this.listenTo(this.model,"backgrid:edit",function(e,t,n,r){t.get("name")==this.column.get("name")&&(r.setOptionValues(this.optionValues),r.setMultiple(this.multiple))})},render:function(){this.$el.empty();var e=t.result(this,"optionValues"),n=this.model,r=this.formatter.fromRaw(n.get(this.column.get("name")),n),i=[];try{if(!t.isArray(e)||t.isEmpty(e))throw new TypeError;for(var s=0;s<r.length;s++){var o=r[s];for(var u=0;u<e.length;u++){var a=e[u];if(t.isArray(a)){var f=a[0],a=a[1];a==o&&i.push(f)}else{if(!t.isObject(a))throw new TypeError;var l=a.values;for(var c=0;c<l.length;c++){var h=l[c];h[1]==o&&i.push(h[0])}}}}this.$el.append(i.join(this.delimiter))}catch(p){throw p instanceof TypeError?new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}"):p}return this.delegateEvents(),this}}),D=a.Column=n.Model.extend({defaults:{name:undefined,label:undefined,sortable:!0,editable:!0,renderable:!0,formatter:undefined,sortType:"cycle",sortValue:undefined,direction:null,cell:undefined,headerCell:undefined},initialize:function(){this.has("label")||this.set({label:this.get("name")},{silent:!0});var e=a.resolveNameToClass(this.get("headerCell"),"HeaderCell"),t=a.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:t,headerCell:e},{silent:!0})},sortValue:function(){var e=this.get("sortValue");return t.isString(e)?this[e]:t.isFunction(e)?e:function(e,t){return e.get(t)}}});t.each(["sortable","renderable","editable"],function(e){D.prototype[e]=function(){var n=this.get(e);return t.isString(n)?this[n]:t.isFunction(n)?n:!!n}});var P=a.Columns=n.Collection.extend({model:D}),H=a.Row=n.View.extend({tagName:"tr",initialize:function(e){var t=this.columns=e.columns;t instanceof n.Collection||(t=this.columns=new P(t));var r=this.cells=[];for(var i=0;i<t.length;i++)r.push(this.makeCell(t.at(i),e));this.listenTo(t,"add",function(t,n){var i=n.indexOf(t),s=this.makeCell(t,e);r.splice(i,0,s);var o=this.$el;i===0?o.prepend(s.render().$el):i===n.length-1?o.append(s.render().$el):o.children().eq(i).before(s.render().$el)}),this.listenTo(t,"remove",function(e,t,n){r[n.index].remove(),r.splice(n.index,1)})},makeCell:function(e){return new(e.get("cell"))({column:e,model:this.model})},render:function(){this.$el.empty();var e=document.createDocumentFragment();for(var t=0;t<this.cells.length;t++)e.appendChild(this.cells[t].render().el);return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;e<this.cells.length;e++){var t=this.cells[e];t.remove.apply(t,arguments)}return n.View.prototype.remove.apply(this,arguments)}}),B=a.EmptyRow=n.View.extend({tagName:"tr",emptyText:null,initialize:function(e){this.emptyText=e.emptyText,this.columns=e.columns},render:function(){this.$el.empty();var e=document.createElement("td");return e.setAttribute("colspan",this.columns.length),e.appendChild(document.createTextNode(t.result(this,"emptyText"))),this.el.className="empty",this.el.appendChild(e),this}}),j=a.HeaderCell=n.View.extend({tagName:"th",events:{"click a":"onClick"},initialize:function(e){this.column=e.column,this.column instanceof D||(this.column=new D(this.column));var t=this.column,n=this.collection,r=this.$el;this.listenTo(t,"change:editable change:sortable change:renderable",function(e){var t=e.changedAttributes();for(var n in t)t.hasOwnProperty(n)&&r.toggleClass(n,t[n])}),this.listenTo(t,"change:direction",this.setCellDirection),this.listenTo(t,"change:name change:label",this.render),a.callByNeed(t.editable(),t,n)&&r.addClass("editable"),a.callByNeed(t.sortable(),t,n)&&r.addClass("sortable"),a.callByNeed(t.renderable(),t,n)&&r.addClass("renderable"),this.listenTo(n.fullCollection||n,"sort",this.removeCellDirection)},removeCellDirection:function(){this.$el.removeClass("ascending").removeClass("descending"),this.column.set("direction",null)},setCellDirection:function(e,t){this.$el.removeClass("ascending").removeClass("descending"),e.cid==this.column.cid&&this.$el.addClass(t)},onClick:function(e){function i(e,i){t.get("direction")==="ascending"?n.trigger(r,i,"descending"):t.get("direction")==="descending"?n.trigger(r,i,null):n.trigger(r,i,"ascending")}function s(e,i){t.get("direction")==="ascending"?n.trigger(r,i,"descending"):n.trigger(r,i,"ascending")}e.preventDefault();var t=this.column,n=this.collection,r="backgrid:sort",o=a.callByNeed(t.sortable(),t,this.collection);if(o){var u=t.get("sortType");u==="toggle"?s(this,t):i(this,t)}},render:function(){this.$el.empty();var e=this.column,t=a.callByNeed(e.sortable(),e,this.collection),n;return t?n=u("<a>").text(e.get("label")).append("<b class='sort-caret'></b>"):n=document.createTextNode(e.get("label")),this.$el.append(n),this.$el.addClass(e.get("name")),this.$el.addClass(e.get("direction")),this.delegateEvents(),this}}),F=a.HeaderRow=a.Row.extend({requiredOptions:["columns","collection"],initialize:function(){a.Row.prototype.initialize.apply(this,arguments)},makeCell:function(e,t){var n=e.get("headerCell")||t.headerCell||j;return n=new n({column:e,collection:this.collection}),n}}),I=a.Header=n.View.extend({tagName:"thead",initialize:function(e){this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new P(this.columns)),this.row=new a.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),n.View.prototype.remove.apply(this,arguments)}}),q=a.Body=n.View.extend({tagName:"tbody",initialize:function(e){this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new P(this.columns)),this.row=e.row||H,this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this.emptyText=e.emptyText,this._unshiftEmptyRowMayBe();var t=this.collection;this.listenTo(t,"add",this.insertRow),this.listenTo(t,"remove",this.removeRow),this.listenTo(t,"sort",this.refresh),this.listenTo(t,"reset",this.refresh),this.listenTo(t,"backgrid:sort",this.sort),this.listenTo(t,"backgrid:edited",this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){this.rows.length===0&&this.emptyText!=null&&this.rows.unshift(new B({emptyText:this.emptyText,columns:this.columns}))},insertRow:function(e,t,r){this.rows[0]instanceof B&&this.rows.pop().remove();if(t instanceof n.Collection||!!r){var i=new this.row({columns:this.columns,model:e}),s=t.indexOf(e);this.rows.splice(s,0,i);var o=this.$el,u=o.children(),a=i.render().$el;return s>=u.length?o.append(a):u.eq(s).before(a),this}this.collection.add(e,r=t);return},removeRow:function(e,n,r){if(!r){this.collection.remove(e,r=n),this._unshiftEmptyRowMayBe();return}return(t.isUndefined(r.render)||r.render)&&this.rows[r.index].remove(),this.rows.splice(r.index,1),this._unshiftEmptyRowMayBe(),this},refresh:function(){for(var e=0;e<this.rows.length;e++)this.rows[e].remove();return this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();var e=document.createDocumentFragment();for(var t=0;t<this.rows.length;t++){var n=this.rows[t];e.appendChild(n.render().el)}return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;e<this.rows.length;e++){var t=this.rows[e];t.remove.apply(t,arguments)}return n.View.prototype.remove.apply(this,arguments)},sort:function(e,r){if(!t.contains(["ascending","descending",null],r))throw new RangeError('direction must be one of "ascending", "descending" or `null`');t.isString(e)&&(e=this.columns.findWhere({name:e}));var i=this.collection,s;r==="ascending"?s=-1:r==="descending"?s=1:s=null;var o=this.makeComparator(e.get("name"),s,s?e.sortValue():function(e){return e.cid.replace("c","")*1});return n.PageableCollection&&i instanceof n.PageableCollection?(i.setSorting(s&&e.get("name"),s,{sortValue:e.sortValue()}),i.fullCollection?(i.fullCollection.comparator==null&&(i.fullCollection.comparator=o),i.fullCollection.sort(),i.trigger("backgrid:sorted",e,r,i)):i.fetch({reset:!0,success:function(){i.trigger("backgrid:sorted",e,r,i)}})):(i.comparator=o,i.sort(),i.trigger("backgrid:sorted",e,r,i)),e.set("direction",r),this},makeComparator:function(e,t,n){return function(r,i){var s=n(r,e),o=n(i,e),u;return t===1&&(u=s,s=o,o=u),s===o?0:s<o?-1:1}},moveToNextCell:function(e,t,n){var r=this.collection.indexOf(e),i=this.columns.indexOf(t),s,o,u,f,l;this.rows[r].cells[i].exitEditMode();if(n.moveUp()||n.moveDown()||n.moveLeft()||n.moveRight()||n.save()){var c=this.columns.length,h=c*this.collection.length;if(n.moveUp()||n.moveDown()){f=r+(n.moveUp()?-1:1);var p=this.rows[f];p?(s=p.cells[i],a.callByNeed(s.column.editable(),s.column,e)&&(s.enterEditMode(),e.trigger("backgrid:next",f,i,!1))):e.trigger("backgrid:next",f,i,!0)}else if(n.moveLeft()||n.moveRight()){var d=n.moveRight();for(var v=r*c+i+(d?1:-1);v>=0&&v<h;d?v++:v--){f=~~(v/c),l=v-f*c,s=this.rows[f].cells[l],o=a.callByNeed(s.column.renderable(),s.column,s.model),u=a.callByNeed(s.column.editable(),s.column,e);if(o&&u){s.enterEditMode(),e.trigger("backgrid:next",f,l,!1);break}}v==h&&e.trigger("backgrid:next",~~(v/c),v-f*c,!0)}}return this}}),R=a.Footer=n.View.extend({tagName:"tfoot",initialize:function(e){this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new a.Columns(this.columns))}}),U=a.Grid=n.View.extend({tagName:"table",className:"backgrid",header:I,body:q,footer:null,initialize:function(e){e.columns instanceof n.Collection||(e.columns=new P(e.columns)),this.columns=e.columns;var r=t.omit(e,["el","id","attributes","className","tagName","events"]);this.body=e.body||this.body,this.body=new this.body(r),this.header=e.header||this.header,this.header&&(this.header=new this.header(r)),this.footer=e.footer||this.footer,this.footer&&(this.footer=new this.footer(r)),this.listenTo(this.columns,"reset",function(){this.header&&(this.header=new(this.header.remove().constructor)(r)),this.body=new(this.body.remove().constructor)(r),this.footer&&(this.footer=new(this.footer.remove().constructor)(r)),this.render()})},insertRow:function(){return this.body.insertRow.apply(this.body,arguments),this},removeRow:function(){return this.body.removeRow.apply(this.body,arguments),this},insertColumn:function(){return this.columns.add.apply(this.columns,arguments),this},removeColumn:function(){return this.columns.remove.apply(this.columns,arguments),this},sort:function(){return this.body.sort.apply(this.body,arguments),this},render:function(){return this.$el.empty(),this.header&&this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header&&this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),n.View.prototype.remove.apply(this,arguments)}});return a});