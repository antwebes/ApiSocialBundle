/*
  backgrid-paginator
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/

(function(e,t){typeof exports=="object"?module.exports=t(require("underscore"),require("backbone"),require("backgrid"),require("backbone-pageable")):t(e._,e.Backbone,e.Backgrid)})(this,function(e,t,n){var r=n.Extension.PageHandle=t.View.extend({tagName:"li",events:{"click a":"changePage"},title:e.template("Page <%- label %>",null,{variable:null}),isRewind:!1,isBack:!1,isForward:!1,isFastForward:!1,initialize:function(t){var n=this.collection,r=n.state,i=r.currentPage,s=r.firstPage,o=r.lastPage;e.extend(this,e.pick(t,["isRewind","isBack","isForward","isFastForward"]));var u;this.isRewind?u=s:this.isBack?u=Math.max(s,i-1):this.isForward?u=Math.min(o,i+1):this.isFastForward?u=o:(u=+t.pageIndex,u=s?u+1:u),this.pageIndex=u,this.label=(t.label||(s?u:u+1))+"";var a=t.title||this.title;this.title=e.isFunction(a)?a({label:this.label}):a},render:function(){this.$el.empty();var e=document.createElement("a");e.href="#",this.title&&(e.title=this.title),e.innerHTML=this.label,this.el.appendChild(e);var t=this.collection,n=t.state,r=n.currentPage,i=this.pageIndex;return this.isRewind&&r==n.firstPage||this.isBack&&!t.hasPrevious()||this.isForward&&!t.hasNext()||this.isFastForward&&(r==n.lastPage||n.totalPages<1)?this.$el.addClass("disabled"):!(this.isRewind||this.isBack||this.isForward||this.isFastForward)&&n.currentPage==i&&this.$el.addClass("active"),this.delegateEvents(),this},changePage:function(e){e.preventDefault();var t=this.$el,n=this.collection;return!t.hasClass("active")&&!t.hasClass("disabled")&&(this.isRewind?n.getFirstPage():this.isBack?n.getPreviousPage():this.isForward?n.getNextPage():this.isFastForward?n.getLastPage():n.getPage(this.pageIndex,{reset:!0})),this}}),i=n.Extension.Paginator=t.View.extend({className:"backgrid-paginator",windowSize:10,slideScale:.5,controls:{rewind:{label:"《",title:"First"},back:{label:"〈",title:"Previous"},forward:{label:"〉",title:"Next"},fastForward:{label:"》",title:"Last"}},renderIndexedPageHandles:!0,pageHandle:r,goBackFirstOnSort:!0,initialize:function(t){var n=this;n.controls=e.defaults(t.controls||{},n.controls,i.prototype.controls),e.extend(n,e.pick(t||{},"windowSize","pageHandle","slideScale","goBackFirstOnSort","renderIndexedPageHandles"));var r=n.collection;n.listenTo(r,"add",n.render),n.listenTo(r,"remove",n.render),n.listenTo(r,"reset",n.render),n.listenTo(r,"backgrid:sorted",function(){n.goBackFirstOnSort&&r.getFirstPage({reset:!0})})},slideMaybe:function(e,t,n,r,i){return Math.round(n%r/r)},slideThisMuch:function(e,t,n,r,i){return~~(r*i)},_calculateWindow:function(){var e=this.collection,t=e.state,n=t.firstPage,r=+t.lastPage;r=Math.max(0,n?r-1:r);var i=Math.max(t.currentPage,t.firstPage);i=n?i-1:i;var s=this.windowSize,o=this.slideScale,u=Math.floor(i/s)*s;i<=r-this.slideThisMuch()&&(u+=this.slideMaybe(n,r,i,s,o)*this.slideThisMuch(n,r,i,s,o));var a=Math.min(r+1,u+s);return[u,a]},makeHandles:function(){var t=[],n=this.collection,r=this._calculateWindow(),i=r[0],s=r[1];if(this.renderIndexedPageHandles)for(var o=i;o<s;o++)t.push(new this.pageHandle({collection:n,pageIndex:o}));var u=this.controls;return e.each(["back","rewind","forward","fastForward"],function(e){var r=u[e];if(r){var i={collection:n,title:r.title,label:r.label};i["is"+e.slice(0,1).toUpperCase()+e.slice(1)]=!0;var s=new this.pageHandle(i);e=="rewind"||e=="back"?t.unshift(s):t.push(s)}},this),t},render:function(){this.$el.empty();if(this.handles)for(var e=0,t=this.handles.length;e<t;e++)this.handles[e].remove();var n=this.handles=this.makeHandles(),r=document.createElement("ul");for(var e=0;e<n.length;e++)r.appendChild(n[e].render().el);return this.el.appendChild(r),this}})});