(function(){Backbone.TemplateManager={templates:{},baseUrl:"/templates/{name}",loadings:new Array,currentViews:{},queues:{},set:function(e,t){this.templates[e]=t;var n=this.queues[e];if(n)for(var r=0;r<n.length;r++)n[r].dfd.resolveWith(n[r].context,[t]);this.queues[e]=new Array},notLoading:function(e){var t=this.loadings.indexOf(e);if(t!=-1){var n=this.loadings.slice(t+1||this.loadings.length);return this.loadings.length=t<0?this.loadings.length+t:t,this.loadings.push.apply(this,n)}},get:function(e,t){if(e==null)throw"Template name must be defined";var n=$.Deferred();if(this.templates[e])n.resolveWith(t,[this.templates[e]]);else{this.queues[e]||(this.queues[e]=new Array),this.queues[e].push({dfd:n,context:t});if(this.loadings.indexOf(e)==-1){this.loadings.push(e);var r=Backbone.TemplateManager.baseUrl.replace("{name}",e);$.get(r,function(t){var n=_.template(t);Backbone.TemplateManager.notLoading(e),Backbone.TemplateManager.set(e,n)}).error(function(){Backbone.TemplateManager.notLoading(e)})}}return n.promise()}},Backbone.DeferedView=Backbone.View.extend({templateName:null,container:null,loadedCountDown:1,deferedRender:function(e){var t=this.templateName,n=$.when(Backbone.TemplateManager.get(this.templateName,this)).then(function(t){this.template=t,this.render(),this.isLoaded(!0),e!=undefined&&typeof e=="function"&&e()});return this},getHelpers:function(){return{displaySize:function(e){var t=["B","KB","MB","GB","TB"];if(e==0)return"0 B";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(e/Math.pow(1024,n)).toFixed(2)+" "+t[n]},displayDate:function(e){return(new Date(e)).toLocaleString()}}},renderTo:function(e,t){return Backbone.TemplateManager.currentViews[e]&&Backbone.TemplateManager.currentViews[e].close(),Backbone.TemplateManager.currentViews[e]=this,this.isLoaded(!1),$(e).html(this.deferedRender(t).el),this},isLoaded:function(e){return e!=undefined&&(this.loadedCountDown+=e?-1:1,this.loadedCountDown>0?$(this.el).addClass("loading"):$(this.el).removeClass("loading")),this.loadedCountDown==0},close:function(){typeof this.onPreClose=="function"&&this.onPreClose(),this.remove(),this.unbind(),typeof this.onClose=="function"&&this.onClose()}})})();